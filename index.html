<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YAFA Loan-Based Investment Model Calculator</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8fffe 0%, #ffffff 100%);
            min-height: 100vh;
            color: #1a1a1a;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px 0;
        }
        
        h1 {
            font-size: 2.5em;
            font-weight: 700;
            background: linear-gradient(135deg, #22c55e, #16a34a, #15803d);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.1em;
            color: #6b7280;
            font-weight: 400;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid rgba(34, 197, 94, 0.2);
            padding-bottom: 0;
            flex-wrap: wrap;
        }
        
        .tab-button {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(34, 197, 94, 0.2);
            border-bottom: none;
            border-radius: 12px 12px 0 0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            color: #374151;
            font-size: 0.95em;
        }
        
        .tab-button:hover {
            background: rgba(34, 197, 94, 0.1);
        }
        
        .tab-button.active {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .input-section {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(34, 197, 94, 0.2);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(34, 197, 94, 0.1);
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 1.4em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #22c55e;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 500;
            margin-bottom: 8px;
            color: #374151;
            font-size: 0.9em;
        }
        
        input, select {
            padding: 12px 14px;
            border: 2px solid rgba(34, 197, 94, 0.2);
            border-radius: 10px;
            font-size: 15px;
            background: rgba(255, 255, 255, 0.8);
            color: #1a1a1a;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #22c55e;
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .calculate-btn {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            font-size: 16px;
            font-weight: 600;
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 15px;
        }
        
        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(34, 197, 94, 0.4);
        }
        
        .results-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(34, 197, 94, 0.2);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(34, 197, 94, 0.1);
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .summary-card {
            background: rgba(34, 197, 94, 0.05);
            border: 1px solid rgba(34, 197, 94, 0.2);
            padding: 18px;
            border-radius: 10px;
            text-align: center;
        }
        
        .summary-card h4 {
            margin: 0 0 8px 0;
            font-size: 0.85em;
            color: #374151;
            font-weight: 500;
        }
        
        .summary-card .value {
            font-size: 1.3em;
            font-weight: 700;
            color: #22c55e;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(34, 197, 94, 0.2);
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }
        
        th, td {
            padding: 10px;
            text-align: right;
            border-bottom: 1px solid rgba(34, 197, 94, 0.1);
        }
        
        th {
            background: rgba(34, 197, 94, 0.1);
            color: #16a34a;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td:first-child, th:first-child {
            text-align: left;
            font-weight: 600;
            color: #16a34a;
        }
        
        .info-box {
            background: rgba(34, 197, 94, 0.08);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 10px;
            padding: 18px;
            margin: 15px 0;
        }
        
        .info-box h3 {
            color: #16a34a;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }
        
        .info-item {
            background: rgba(255, 255, 255, 0.8);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(34, 197, 94, 0.2);
        }
        
        .info-label {
            font-size: 0.85em;
            color: #6b7280;
            margin-bottom: 4px;
        }
        
        .info-value {
            font-size: 1.1em;
            font-weight: 600;
            color: #22c55e;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>YAFA Loan-Based Investment Model</h1>
            <div class="subtitle">Collective Investment Through Business Loans</div>
        </div>
        
        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('loan-main', this)">Loan Model Main</button>
            <button class="tab-button" onclick="switchTab('investor-returns', this)">Investor Returns</button>
            <button class="tab-button" onclick="switchTab('g2-returns', this)">G2 Returns</button>
            <button class="tab-button" onclick="switchTab('loan-repayment', this)">Loan Repayment</button>
            <button class="tab-button" onclick="switchTab('selling-pressure', this)">Selling Pressure</button>
            <button class="tab-button" onclick="switchTab('yafa-impact', this)">Yafa Net Impact</button>
        </div>
        
        <!-- Loan Model Main Tab -->
        <div id="loan-main" class="tab-button active">
            <div class="input-section">
                <h2 class="section-title">üè¶ Loan Structure Parameters</h2>
                
                <div class="input-grid">
                    <div class="input-group">
                        <label for="numInvestors">Number of Investors</label>
                        <input type="number" id="numInvestors" value="25" min="1" step="1">
                    </div>
                    <div class="input-group">
                        <label for="loanAmount">Loan Amount per Investor ($)</label>
                        <input type="number" id="loanAmount" value="300000" min="100000" step="50000">
                    </div>
                    <div class="input-group">
                        <label for="interestRate">Investor Interest Rate (%)</label>
                        <input type="number" id="interestRate" value="8" min="0" max="20" step="0.5">
                    </div>
                    <div class="input-group">
                        <label for="amortization">Amortization Period</label>
                        <select id="amortization">
                            <option value="3">3 Years</option>
                            <option value="4">4 Years</option>
                            <option value="5">5 Years</option>
                            <option value="6">6 Years</option>
                            <option value="7" selected>7 Years</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="g2Fee">G2 Global Success Fee</label>
                        <select id="g2Fee">
                            <option value="5">5%</option>
                            <option value="10" selected>10%</option>
                            <option value="15">15%</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="costPerFile">Cost per Investor File ($)</label>
                        <input type="number" id="costPerFile" value="26500" min="0" step="500">
                    </div>
                </div>
                
                <h2 class="section-title" style="margin-top: 30px;">üìà Market & Growth Parameters</h2>
                
                <div class="input-grid">
                    <div class="input-group">
                        <label for="annualGrowth">Annual YAFA Growth (%)</label>
                        <input type="number" id="annualGrowth" value="20" min="0" max="100" step="1">
                    </div>
                    <div class="input-group">
                        <label for="investorWithdrawPercent">Investor % of Vested Tokens Sold</label>
                        <input type="number" id="investorWithdrawPercent" value="50" min="0" max="100" step="10">
                    </div>
                    <div class="input-group">
                        <label for="g2WithdrawPercent">G2 % of Vested Tokens Sold</label>
                        <input type="number" id="g2WithdrawPercent" value="50" min="0" max="100" step="10">
                    </div>
                    <div class="input-group">
                        <label for="projectionYears">Projection Years</label>
                        <input type="number" id="projectionYears" value="10" min="5" max="20" step="1">
                    </div>
                </div>
                
                <button class="calculate-btn" onclick="calculateLoanModel()">Calculate Loan Model</button>
            </div>
            
            <div id="loan-main-results" class="hidden">
                <div class="info-box">
                    <h3>Deal Structure Summary</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Total Loans</div>
                            <div class="info-value" id="totalLoans">$0</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">G2 Success Fees</div>
                            <div class="info-value" id="g2TotalFees">$0</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">G2 Investment (50%)</div>
                            <div class="info-value" id="g2Investment">$0</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Total to Investors</div>
                            <div class="info-value" id="totalToInvestors">$0</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">File Management Fees</div>
                            <div class="info-value" id="fileFees">$0</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Amount to Yafa Ltd (Cash)</div>
                            <div class="info-value" id="amountToYafa">$0</div>
                        </div>
                    </div>
                    <h3 style="margin-top: 20px;">Chart Injection Breakdown</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Total Direct Chart Buys</div>
                            <div class="info-value" id="totalDirectChartBuys">$2,700,000</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">G2 + Investor Chart Buys</div>
                            <div class="info-value" id="g2InvestorChartBuys">$0</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Yafa OTCs</div>
                            <div class="info-value" id="yafaOTCs">$340,000</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Yafa Chart Injection</div>
                            <div class="info-value" id="yafaChartInjection">$0</div>
                        </div>
                    </div>
                </div>
                
                <div class="info-box">
                    <h3>Token Allocation (55M Pool @ $0.50 post-injection)</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Investor Tokens (4x)</div>
                            <div class="info-value" id="investorTokens">0</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">G2 Tokens (4x)</div>
                            <div class="info-value" id="g2Tokens">0</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Yafa Tokens (Remainder)</div>
                            <div class="info-value" id="yafaTokens">0</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Total Supply Allocated</div>
                            <div class="info-value" id="totalAllocated">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Investor Returns Tab -->
        <div id="investor-returns" class="tab-content">
            <div class="results-card">
                <h3 class="section-title">üíº Individual Investor Returns ($100k Investment)</h3>
                <div class="summary-grid" id="investor-summary"></div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Year</th>
                                <th>Tokens Held</th>
                                <th>Tokens Vested</th>
                                <th>Tokens Sold</th>
                                <th>Token Price</th>
                                <th>Total USD Sold</th>
                                <th>Cumulative Sold</th>
                                <th>Remaining Tokens Value</th>
                            </tr>
                        </thead>
                        <tbody id="investor-table"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- G2 Returns Tab -->
        <div id="g2-returns" class="tab-content">
            <div class="results-card">
                <h3 class="section-title">ü§ù G2 Investment Returns</h3>
                <div class="summary-grid" id="g2-summary"></div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Year</th>
                                <th>Tokens Held</th>
                                <th>Tokens Vested</th>
                                <th>Tokens Sold</th>
                                <th>Token Price</th>
                                <th>Total USD Sold</th>
                                <th>Cumulative Sold</th>
                                <th>Remaining Tokens Value</th>
                            </tr>
                        </thead>
                        <tbody id="g2-table"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Loan Repayment Tab -->
        <div id="loan-repayment" class="tab-content">
            <div class="results-card">
                <h3 class="section-title">üìÖ Loan Repayment Schedule (Annual View)</h3>
                <div class="summary-grid" id="loan-summary"></div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Year</th>
                                <th>Annual Payment</th>
                                <th>Principal</th>
                                <th>Interest</th>
                                <th>Remaining Balance</th>
                            </tr>
                        </thead>
                        <tbody id="loan-table"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Selling Pressure Tab -->
        <div id="selling-pressure" class="tab-content">
            <div class="results-card">
                <h3 class="section-title">üìâ Total Market Selling Pressure (Annual View)</h3>
                <div class="info-box">
                    <p>Note: Loan repayments shown for reference but not included in total selling pressure</p>
                </div>
                <div class="table-container">
                    <table id="pressure-table">
                        <thead>
                            <tr>
                                <th>Year</th>
                                <th>Loan Payments (Reference)</th>
                                <th>All Investors Sales</th>
                                <th>G2 Sales</th>
                                <th>Total Selling Pressure</th>
                                <th>Cumulative Pressure</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Yafa Net Impact Tab -->
        <div id="yafa-impact" class="tab-content">
            <div class="results-card">
                <h3 class="section-title">üí∞ Yafa Ltd Net Position</h3>
                <div class="summary-grid" id="yafa-summary"></div>
                <div class="info-box">
                    <h3>Monthly Cashflow Requirements</h3>
                    <div class="info-grid" id="yafa-cashflow"></div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Year</th>
                                <th>Yafa Token Holdings</th>
                                <th>Token Value</th>
                                <th>Annual Loan Obligations</th>
                                <th>Net Position</th>
                                <th>Cumulative Obligations Paid</th>
                            </tr>
                        </thead>
                        <tbody id="yafa-table"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
    </div>

    <script>
        // Constants
        const TOTAL_SUPPLY = 1000000000;
        const POST_INJECTION_PRICE = 0.50;
        const OG_LOCK_MONTHS = 12;
        const OG_VESTING_MONTHS = 60; // 5 years
        const INVESTOR_LOCK_MONTHS = 12;
        const INVESTOR_VESTING_MONTHS = 72; // 6 years
        
        // Global data storage
        let loanModelData = {};
        let investorData = [];
        let g2Data = [];
        let loanSchedule = [];
        let sellingPressureData = [];
        let yafaData = [];
        let ogModelData = [];
        
        function switchTab(tabName, btn) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(tabName);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Highlight active button
            if (btn) {
                btn.classList.add('active');
            }
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }
        
        function formatNumber(amount) {
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }
        
        // Loan Model Calculation
        function calculateLoanModel() {
            // Get inputs
            const numInvestors = parseInt(document.getElementById('numInvestors').value);
            const loanAmount = parseFloat(document.getElementById('loanAmount').value);
            const interestRate = parseFloat(document.getElementById('interestRate').value) / 100;
            const amortization = parseInt(document.getElementById('amortization').value);
            const g2FeePercent = parseFloat(document.getElementById('g2Fee').value) / 100;
            const costPerFile = parseFloat(document.getElementById('costPerFile').value);
            const annualGrowth = parseFloat(document.getElementById('annualGrowth').value) / 100;
            const investorWithdrawPercent = parseFloat(document.getElementById('investorWithdrawPercent').value) / 100;
            const g2WithdrawPercent = parseFloat(document.getElementById('g2WithdrawPercent').value) / 100;
            const projectionYears = parseInt(document.getElementById('projectionYears').value);
            
            // Calculate deal structure
            const totalLoans = numInvestors * loanAmount;
            const g2TotalFees = totalLoans * g2FeePercent;
            const g2Investment = g2TotalFees * 0.5;
            const totalToInvestors = numInvestors * 100000;
            const totalFileCosts = numInvestors * costPerFile;
            
            // New calculations for chart buys and OTCs
            const totalDirectChartBuys = 2700000;
            const g2InvestorChartBuys = g2Investment + totalToInvestors;
            const yafaOTCs = 340000;
            
            // Calculate Yafa's portion of the chart buys
            const yafaChartInjection = totalDirectChartBuys - g2InvestorChartBuys;
            
            // Calculate amount to Yafa Ltd (remaining cash after all allocations)
            const amountToYafa = totalLoans - g2TotalFees - totalToInvestors - totalFileCosts - yafaOTCs - yafaChartInjection;
            
            // Calculate token allocations from 55M token pool at $0.50
            const totalTokenPool = 55000000;
            const investorTokenAllocation = (totalToInvestors * 4) / POST_INJECTION_PRICE;
            const g2TokenAllocation = (g2Investment * 4) / POST_INJECTION_PRICE;
            const yafaTokens = totalTokenPool - investorTokenAllocation - g2TokenAllocation;
            
            // Store main model data
            loanModelData = {
                numInvestors,
                loanAmount,
                interestRate,
                amortization,
                g2FeePercent,
                totalLoans,
                g2TotalFees,
                g2Investment,
                totalToInvestors,
                totalFileCosts,
                amountToYafa,
                totalDirectChartBuys,
                g2InvestorChartBuys,
                yafaChartInjection,
                yafaOTCs,
                investorTokenAllocation,
                g2TokenAllocation,
                yafaTokens,
                annualGrowth,
                investorWithdrawPercent,
                g2WithdrawPercent,
                projectionYears
            };
            
            // Display main results
            displayLoanMainResults();
            
            // Calculate all projections
            calculateInvestorReturns();
            calculateG2Returns();
            calculateLoanRepayment();
            calculateSellingPressure();
            calculateYafaImpact();
        }
        
        function displayLoanMainResults() {
            document.getElementById('totalLoans').textContent = formatCurrency(loanModelData.totalLoans);
            document.getElementById('g2TotalFees').textContent = formatCurrency(loanModelData.g2TotalFees);
            document.getElementById('g2Investment').textContent = formatCurrency(loanModelData.g2Investment);
            document.getElementById('totalToInvestors').textContent = formatCurrency(loanModelData.totalToInvestors);
            document.getElementById('fileFees').textContent = formatCurrency(loanModelData.totalFileCosts);
            document.getElementById('amountToYafa').textContent = formatCurrency(loanModelData.amountToYafa);
            
            // Display chart injection breakdown
            document.getElementById('totalDirectChartBuys').textContent = formatCurrency(loanModelData.totalDirectChartBuys);
            document.getElementById('g2InvestorChartBuys').textContent = formatCurrency(loanModelData.g2InvestorChartBuys);
            document.getElementById('yafaChartInjection').textContent = formatCurrency(loanModelData.yafaChartInjection);
            document.getElementById('yafaOTCs').textContent = formatCurrency(loanModelData.yafaOTCs);
            
            document.getElementById('investorTokens').textContent = formatNumber(loanModelData.investorTokenAllocation);
            document.getElementById('g2Tokens').textContent = formatNumber(loanModelData.g2TokenAllocation);
            document.getElementById('yafaTokens').textContent = formatNumber(loanModelData.yafaTokens);
            document.getElementById('totalAllocated').textContent = formatNumber(
                loanModelData.investorTokenAllocation + loanModelData.g2TokenAllocation + loanModelData.yafaTokens
            );
            
            document.getElementById('loan-main-results').classList.remove('hidden');
        }
        
        // Updated Investor Returns with proper vesting schedule
        function calculateInvestorReturns() {
            investorData = [];
            const tokensPerInvestor = loanModelData.investorTokenAllocation / loanModelData.numInvestors;
            const annualVestAmount = tokensPerInvestor / 6; // 6-year vest after 1-year lock
            
            let tokensHeld = tokensPerInvestor;
            let totalVested = 0;
            let cumulativeSoldUSD = 0;
            let tokenPrice = POST_INJECTION_PRICE;
            
            for (let year = 1; year <= loanModelData.projectionYears; year++) {
                tokenPrice = POST_INJECTION_PRICE * Math.pow(1 + loanModelData.annualGrowth, year - 1);
                
                let tokensVestedThisYear = 0;
                let tokensSoldThisYear = 0;
                let usdSoldThisYear = 0;
                
                // Year 1: Lock period, no vesting
                if (year === 1) {
                    tokensVestedThisYear = 0;
                    tokensSoldThisYear = 0;
                }
                // Years 2-7: Vesting period
                else if (year >= 2 && year <= 7) {
                    tokensVestedThisYear = annualVestAmount;
                    totalVested += tokensVestedThisYear;
                    tokensSoldThisYear = tokensVestedThisYear * loanModelData.investorWithdrawPercent;
                    tokensHeld -= tokensSoldThisYear;
                    usdSoldThisYear = tokensSoldThisYear * tokenPrice;
                    cumulativeSoldUSD += usdSoldThisYear;
                }
                // Years 8+: No more vesting
                else {
                    tokensVestedThisYear = 0;
                    tokensSoldThisYear = 0;
                }
                
                investorData.push({
                    year,
                    tokensHeld,
                    tokensVested: tokensVestedThisYear,
                    tokensSold: tokensSoldThisYear,
                    tokenPrice,
                    usdSold: usdSoldThisYear,
                    cumulativeSoldUSD,
                    remainingValue: tokensHeld * tokenPrice
                });
            }
            
            displayInvestorReturns();
        }
        
        function displayInvestorReturns() {
            const finalData = investorData[investorData.length - 1];
            const totalReturn = finalData.cumulativeSoldUSD + finalData.remainingValue;
            const roi = ((totalReturn - 100000) / 100000 * 100).toFixed(0);
            
            document.getElementById('investor-summary').innerHTML = `
                <div class="summary-card">
                    <h4>Investment</h4>
                    <div class="value">$100,000</div>
                </div>
                <div class="summary-card">
                    <h4>Tokens Allocated (4x)</h4>
                    <div class="value">${formatNumber(loanModelData.investorTokenAllocation / loanModelData.numInvestors)}</div>
                </div>
                <div class="summary-card">
                    <h4>Final Portfolio</h4>
                    <div class="value">${formatCurrency(finalData.remainingValue)}</div>
                </div>
                <div class="summary-card">
                    <h4>Total Withdrawn</h4>
                    <div class="value">${formatCurrency(finalData.cumulativeSoldUSD)}</div>
                </div>
                <div class="summary-card">
                    <h4>Total Return</h4>
                    <div class="value">${formatCurrency(totalReturn)}</div>
                </div>
                <div class="summary-card">
                    <h4>ROI</h4>
                    <div class="value">${roi}%</div>
                </div>
            `;
            
            document.getElementById('investor-table').innerHTML = investorData.map(row => `
                <tr>
                    <td>Year ${row.year}</td>
                    <td>${formatNumber(row.tokensHeld)}</td>
                    <td>${formatNumber(row.tokensVested)}</td>
                    <td>${formatNumber(row.tokensSold)}</td>
                    <td>${row.tokenPrice.toFixed(3)}</td>
                    <td>${formatCurrency(row.usdSold)}</td>
                    <td>${formatCurrency(row.cumulativeSoldUSD)}</td>
                    <td>${formatCurrency(row.remainingValue)}</td>
                </tr>
            `).join('');
        }
        
        // Updated G2 Returns with proper vesting schedule
        function calculateG2Returns() {
            g2Data = [];
            const g2Tokens = loanModelData.g2TokenAllocation;
            const annualVestAmount = g2Tokens / 6; // 6-year vest after 1-year lock
            
            let tokensHeld = g2Tokens;
            let totalVested = 0;
            let cumulativeSoldUSD = 0;
            let tokenPrice = POST_INJECTION_PRICE;
            
            for (let year = 1; year <= loanModelData.projectionYears; year++) {
                tokenPrice = POST_INJECTION_PRICE * Math.pow(1 + loanModelData.annualGrowth, year - 1);
                
                let tokensVestedThisYear = 0;
                let tokensSoldThisYear = 0;
                let usdSoldThisYear = 0;
                
                // Year 1: Lock period, no vesting
                if (year === 1) {
                    tokensVestedThisYear = 0;
                    tokensSoldThisYear = 0;
                }
                // Years 2-7: Vesting period
                else if (year >= 2 && year <= 7) {
                    tokensVestedThisYear = annualVestAmount;
                    totalVested += tokensVestedThisYear;
                    tokensSoldThisYear = tokensVestedThisYear * loanModelData.g2WithdrawPercent;
                    tokensHeld -= tokensSoldThisYear;
                    usdSoldThisYear = tokensSoldThisYear * tokenPrice;
                    cumulativeSoldUSD += usdSoldThisYear;
                }
                // Years 8+: No more vesting
                else {
                    tokensVestedThisYear = 0;
                    tokensSoldThisYear = 0;
                }
                
                g2Data.push({
                    year,
                    tokensHeld,
                    tokensVested: tokensVestedThisYear,
                    tokensSold: tokensSoldThisYear,
                    tokenPrice,
                    usdSold: usdSoldThisYear,
                    cumulativeSoldUSD,
                    remainingValue: tokensHeld * tokenPrice
                });
            }
            
            displayG2Returns();
        }
        
        function displayG2Returns() {
            const finalData = g2Data[g2Data.length - 1];
            const totalReturn = finalData.cumulativeSoldUSD + finalData.remainingValue;
            const roi = ((totalReturn - loanModelData.g2Investment) / loanModelData.g2Investment * 100).toFixed(0);
            
            document.getElementById('g2-summary').innerHTML = `
                <div class="summary-card">
                    <h4>G2 Investment</h4>
                    <div class="value">${formatCurrency(loanModelData.g2Investment)}</div>
                </div>
                <div class="summary-card">
                    <h4>Tokens Allocated (4x)</h4>
                    <div class="value">${formatNumber(loanModelData.g2TokenAllocation)}</div>
                </div>
                <div class="summary-card">
                    <h4>Final Portfolio</h4>
                    <div class="value">${formatCurrency(finalData.remainingValue)}</div>
                </div>
                <div class="summary-card">
                    <h4>Total Withdrawn</h4>
                    <div class="value">${formatCurrency(finalData.cumulativeSoldUSD)}</div>
                </div>
                <div class="summary-card">
                    <h4>Total Return</h4>
                    <div class="value">${formatCurrency(totalReturn)}</div>
                </div>
                <div class="summary-card">
                    <h4>ROI</h4>
                    <div class="value">${roi}%</div>
                </div>
            `;
            
            document.getElementById('g2-table').innerHTML = g2Data.map(row => `
                <tr>
                    <td>Year ${row.year}</td>
                    <td>${formatNumber(row.tokensHeld)}</td>
                    <td>${formatNumber(row.tokensVested)}</td>
                    <td>${formatNumber(row.tokensSold)}</td>
                    <td>${row.tokenPrice.toFixed(3)}</td>
                    <td>${formatCurrency(row.usdSold)}</td>
                    <td>${formatCurrency(row.cumulativeSoldUSD)}</td>
                    <td>${formatCurrency(row.remainingValue)}</td>
                </tr>
            `).join('');
        }
        
        // Updated Loan Repayment - Annual View
        function calculateLoanRepayment() {
            loanSchedule = [];
            const monthlyRate = loanModelData.interestRate / 12;
            const totalMonths = loanModelData.amortization * 12;
            const loanPerInvestor = loanModelData.loanAmount;
            
            // Calculate monthly payment using amortization formula
            const monthlyPayment = loanPerInvestor * (monthlyRate * Math.pow(1 + monthlyRate, totalMonths)) / 
                                   (Math.pow(1 + monthlyRate, totalMonths) - 1);
            
            let remainingBalance = loanPerInvestor * loanModelData.numInvestors;
            
            // Calculate annual summaries
            for (let year = 1; year <= loanModelData.amortization; year++) {
                let annualPayment = 0;
                let annualPrincipal = 0;
                let annualInterest = 0;
                
                for (let month = 1; month <= 12; month++) {
                    if ((year - 1) * 12 + month <= totalMonths) {
                        const interest = remainingBalance * monthlyRate;
                        const principal = (monthlyPayment * loanModelData.numInvestors) - interest;
                        
                        annualPayment += monthlyPayment * loanModelData.numInvestors;
                        annualPrincipal += principal;
                        annualInterest += interest;
                        remainingBalance -= principal;
                    }
                }
                
                loanSchedule.push({
                    year,
                    annualPayment,
                    annualPrincipal,
                    annualInterest,
                    remainingBalance: Math.max(0, remainingBalance)
                });
            }
            
            displayLoanRepayment();
        }
        
        function displayLoanRepayment() {
            const totalPayments = loanSchedule.reduce((sum, row) => sum + row.annualPayment, 0);
            const totalInterest = totalPayments - loanModelData.totalLoans;
            
            document.getElementById('loan-summary').innerHTML = `
                <div class="summary-card">
                    <h4>Total Loan Amount</h4>
                    <div class="value">${formatCurrency(loanModelData.totalLoans)}</div>
                </div>
                <div class="summary-card">
                    <h4>Annual Payment (Avg)</h4>
                    <div class="value">${formatCurrency(totalPayments / loanModelData.amortization)}</div>
                </div>
                <div class="summary-card">
                    <h4>Total Interest</h4>
                    <div class="value">${formatCurrency(totalInterest)}</div>
                </div>
                <div class="summary-card">
                    <h4>Total Payments</h4>
                    <div class="value">${formatCurrency(totalPayments)}</div>
                </div>
            `;
            
            document.getElementById('loan-table').innerHTML = loanSchedule.map(row => `
                <tr>
                    <td>Year ${row.year}</td>
                    <td>${formatCurrency(row.annualPayment)}</td>
                    <td>${formatCurrency(row.annualPrincipal)}</td>
                    <td>${formatCurrency(row.annualInterest)}</td>
                    <td>${formatCurrency(row.remainingBalance)}</td>
                </tr>
            `).join('');
        }
        
        // Updated Selling Pressure - Annual View
        function calculateSellingPressure() {
            sellingPressureData = [];
            let cumulativePressure = 0;
            
            for (let year = 1; year <= loanModelData.projectionYears; year++) {
                // Get loan payment for this year (reference only)
                let loanPayment = 0;
                if (year <= loanSchedule.length) {
                    loanPayment = loanSchedule[year - 1].annualPayment;
                }
                
                // Get investor sales for this year (all investors combined)
                let investorSales = 0;
                if (year <= investorData.length) {
                    investorSales = investorData[year - 1].usdSold * loanModelData.numInvestors;
                }
                
                // Get G2 sales for this year
                let g2Sales = 0;
                if (year <= g2Data.length) {
                    g2Sales = g2Data[year - 1].usdSold;
                }
                
                // Total selling pressure excludes loan payments
                const totalPressure = investorSales + g2Sales;
                cumulativePressure += totalPressure;
                
                sellingPressureData.push({
                    year,
                    loanPayment,
                    investorSales,
                    g2Sales,
                    totalPressure,
                    cumulativePressure
                });
            }
            
            displaySellingPressure();
        }
        
        function displaySellingPressure() {
            const tableBody = document.querySelector('#pressure-table tbody');
            tableBody.innerHTML = sellingPressureData.map(row => `
                <tr>
                    <td>Year ${row.year}</td>
                    <td>${formatCurrency(row.loanPayment)}</td>
                    <td>${formatCurrency(row.investorSales)}</td>
                    <td>${formatCurrency(row.g2Sales)}</td>
                    <td>${formatCurrency(row.totalPressure)}</td>
                    <td>${formatCurrency(row.cumulativePressure)}</td>
                </tr>
            `).join('');
        }
        
        function calculateYafaImpact() {
            yafaData = [];
            let yafaTokens = loanModelData.yafaTokens;
            let tokenPrice = POST_INJECTION_PRICE;
            let cumulativeObligations = 0;
            
            for (let year = 1; year <= loanModelData.projectionYears; year++) {
                tokenPrice = POST_INJECTION_PRICE * Math.pow(1 + loanModelData.annualGrowth, year - 1);
                
                let annualObligations = 0;
                if (year <= loanSchedule.length) {
                    annualObligations = loanSchedule[year - 1].annualPayment;
                }
                
                cumulativeObligations += annualObligations;
                const tokenValue = yafaTokens * tokenPrice;
                const netPosition = tokenValue - annualObligations;
                
                yafaData.push({
                    year,
                    yafaTokens,
                    tokenPrice,
                    tokenValue,
                    annualObligations,
                    netPosition,
                    cumulativeObligations
                });
            }
            
            displayYafaImpact();
        }
        
        function displayYafaImpact() {
            const finalData = yafaData[yafaData.length - 1];
            
            document.getElementById('yafa-summary').innerHTML = `
                <div class="summary-card">
                    <h4>Initial Tokens Reserved</h4>
                    <div class="value">${formatNumber(loanModelData.yafaTokens)}</div>
                </div>
                <div class="summary-card">
                    <h4>Final Token Value</h4>
                    <div class="value">${formatCurrency(finalData.tokenValue)}</div>
                </div>
                <div class="summary-card">
                    <h4>Total Obligations</h4>
                    <div class="value">${formatCurrency(finalData.cumulativeObligations)}</div>
                </div>
                <div class="summary-card">
                    <h4>Net Position</h4>
                    <div class="value">${formatCurrency(finalData.tokenValue - finalData.cumulativeObligations)}</div>
                </div>
                <div class="summary-card">
                    <h4>Cash Received Day 1</h4>
                    <div class="value">${formatCurrency(loanModelData.amountToYafa)}</div>
                </div>
            `;
            
            // Monthly cashflow requirements
            const monthlyLoanPayment = loanSchedule.length > 0 ? loanSchedule[0].annualPayment / 12 : 0;
            const peakAnnualPressure = Math.max(...sellingPressureData.map(d => d.totalPressure));
            
            document.getElementById('yafa-cashflow').innerHTML = `
                <div class="info-item">
                    <div class="info-label">Monthly Loan Payment</div>
                    <div class="info-value">${formatCurrency(monthlyLoanPayment)}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Peak Annual Selling Pressure</div>
                    <div class="info-value">${formatCurrency(peakAnnualPressure)}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Break-even Year</div>
                    <div class="info-value">${findBreakEvenYear()}</div>
                </div>
            `;
            
            document.getElementById('yafa-table').innerHTML = yafaData.map(row => `
                <tr>
                    <td>Year ${row.year}</td>
                    <td>${formatNumber(row.yafaTokens)}</td>
                    <td>${formatCurrency(row.tokenValue)}</td>
                    <td>${formatCurrency(row.annualObligations)}</td>
                    <td>${formatCurrency(row.netPosition)}</td>
                    <td>${formatCurrency(row.cumulativeObligations)}</td>
                </tr>
            `).join('');
        }
        
        function findBreakEvenYear() {
            for (let i = 0; i < yafaData.length; i++) {
                if (yafaData[i].tokenValue >= yafaData[i].cumulativeObligations) {
                    return `Year ${yafaData[i].year}`;
                }
            }
            return 'Not within projection period';
        }
    </script>
</body>
</html>