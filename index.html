<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YAFA Loan-Based Investment Model Calculator</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8fffe 0%, #ffffff 100%);
            min-height: 100vh;
            color: #1a1a1a;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px 0;
        }
        
        h1 {
            font-size: 2.5em;
            font-weight: 700;
            background: linear-gradient(135deg, #22c55e, #16a34a, #15803d);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.1em;
            color: #6b7280;
            font-weight: 400;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid rgba(34, 197, 94, 0.2);
            padding-bottom: 0;
            flex-wrap: wrap;
        }
        
        .tab-button {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(34, 197, 94, 0.2);
            border-bottom: none;
            border-radius: 12px 12px 0 0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            color: #374151;
            font-size: 0.95em;
        }
        
        .tab-button:hover {
            background: rgba(34, 197, 94, 0.1);
        }
        
        .tab-button.active {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .input-section {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(34, 197, 94, 0.2);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(34, 197, 94, 0.1);
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 1.4em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #22c55e;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 500;
            margin-bottom: 8px;
            color: #374151;
            font-size: 0.9em;
        }
        
        input, select {
            padding: 12px 14px;
            border: 2px solid rgba(34, 197, 94, 0.2);
            border-radius: 10px;
            font-size: 15px;
            background: rgba(255, 255, 255, 0.8);
            color: #1a1a1a;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #22c55e;
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .calculate-btn {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            font-size: 16px;
            font-weight: 600;
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 15px;
        }
        
        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(34, 197, 94, 0.4);
        }
        
        .results-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(34, 197, 94, 0.2);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(34, 197, 94, 0.1);
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .summary-card {
            background: rgba(34, 197, 94, 0.05);
            border: 1px solid rgba(34, 197, 94, 0.2);
            padding: 18px;
            border-radius: 10px;
            text-align: center;
        }
        
        .summary-card h4 {
            margin: 0 0 8px 0;
            font-size: 0.85em;
            color: #374151;
            font-weight: 500;
        }
        
        .summary-card .value {
            font-size: 1.3em;
            font-weight: 700;
            color: #22c55e;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(34, 197, 94, 0.2);
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }
        
        th, td {
            padding: 10px;
            text-align: right;
            border-bottom: 1px solid rgba(34, 197, 94, 0.1);
        }
        
        th {
            background: rgba(34, 197, 94, 0.1);
            color: #16a34a;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td:first-child, th:first-child {
            text-align: left;
            font-weight: 600;
            color: #16a34a;
        }
        
        .info-box {
            background: rgba(34, 197, 94, 0.08);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 10px;
            padding: 18px;
            margin: 15px 0;
        }
        
        .info-box h3 {
            color: #16a34a;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .info-box h4 {
            color: #16a34a;
            margin: 15px 0 10px 0;
            font-size: 1em;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }
        
        .info-item {
            background: rgba(255, 255, 255, 0.8);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(34, 197, 94, 0.2);
        }
        
        .info-label {
            font-size: 0.85em;
            color: #6b7280;
            margin-bottom: 4px;
        }
        
        .info-value {
            font-size: 1.1em;
            font-weight: 600;
            color: #22c55e;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>YAFA Loan-Based Investment Model</h1>
            <div class="subtitle">Collective Investment Through Business Loans</div>
        </div>
        
        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('loan-main', this)">Loan Model Main</button>
            <button class="tab-button" onclick="switchTab('business-returns', this)">Business Returns</button>
            <button class="tab-button" onclick="switchTab('g2-returns', this)">G2 Returns</button>
            <button class="tab-button" onclick="switchTab('loan-repayment', this)">Loan Repayment</button>
            <button class="tab-button" onclick="switchTab('selling-pressure', this)">Selling Pressure</button>
        </div>
        
        <!-- Loan Model Main Tab -->
        <div id="loan-main" class="tab-content active">
            <div class="input-section">
                <h2 class="section-title">üè¶ Loan Structure Parameters</h2>
                
                <div class="input-grid">
                    <div class="input-group">
                        <label for="numInvestors">Number of Purchasers</label>
                        <input type="number" id="numInvestors" value="15" min="1" step="1">
                    </div>
                    <div class="input-group">
                        <label for="loanAmount">Loan Amount per Purchaser ($)</label>
                        <input type="number" id="loanAmount" value="500000" min="100000" step="50000">
                    </div>
                    <div class="input-group">
                        <label for="amountToInvestor">Amount to Purchaser per Loan ($)</label>
                        <input type="number" id="amountToInvestor" value="150000" min="0" step="10000">
                    </div>
                    <div class="input-group">
                        <label for="interestRate">Purchaser Interest Rate (%)</label>
                        <input type="number" id="interestRate" value="6" min="0" max="20" step="0.5">
                    </div>
                    <div class="input-group">
                        <label for="amortization">Amortization Period</label>
                        <select id="amortization">
                            <option value="3">3 Years</option>
                            <option value="4">4 Years</option>
                            <option value="5">5 Years</option>
                            <option value="6">6 Years</option>
                            <option value="7" selected>7 Years</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="businessVesting">Business Vesting Period</label>
                        <select id="businessVesting">
                            <option value="1">1 Year</option>
                            <option value="2">2 Years</option>
                            <option value="3">3 Years</option>
                            <option value="4">4 Years</option>
                            <option value="5">5 Years</option>
                            <option value="6" selected>6 Years</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="g2Fee">G2 Global Success Fee (%)</label>
                        <select id="g2Fee">
                            <option value="5">5%</option>
                            <option value="10" selected>10%</option>
                            <option value="15">15%</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="costPerFile">Cost per Purchaser File ($)</label>
                        <input type="number" id="costPerFile" value="15000" min="0" step="500">
                    </div>
                    <div class="input-group">
                        <label for="investorCashMultiplier">Purchaser Cash Multiplier</label>
                        <input type="number" id="investorCashMultiplier" value="4" min="1" max="10" step="0.5">
                    </div>
                    <div class="input-group">
                        <label for="g2CashMultiplier">G2 Cash Multiplier</label>
                        <input type="number" id="g2CashMultiplier" value="3" min="1" max="10" step="0.5">
                    </div>
                    <div class="input-group">
                        <label for="investmentPercent">% of Amount for Purchase (vs Cash) (%)</label>
                        <input type="number" id="investmentPercent" value="50" min="0" max="100" step="10">
                    </div>
                </div>
                
                <h2 class="section-title" style="margin-top: 30px;">üìà Market & Growth Parameters</h2>
                
                <div class="input-grid">
                    <div class="input-group">
                        <label for="annualGrowth">Annual YAFA Growth (%)</label>
                        <input type="number" id="annualGrowth" value="20" min="0" max="100" step="1">
                    </div>
                    <div class="input-group">
                        <label for="investorWithdrawPercent">Purchaser % of Vested Tokens Sold</label>
                        <input type="number" id="investorWithdrawPercent" value="50" min="0" max="100" step="10">
                    </div>
                    <div class="input-group">
                        <label for="g2WithdrawPercent">G2 % of Vested Tokens Sold</label>
                        <input type="number" id="g2WithdrawPercent" value="50" min="0" max="100" step="10">
                    </div>
                    <div class="input-group">
                        <label for="projectionYears">Projection Years</label>
                        <input type="number" id="projectionYears" value="10" min="5" max="20" step="1">
                    </div>
                    <div class="input-group">
                        <label for="corporateTaxRate">Corporate Tax Rate (%)</label>
                        <input type="number" id="corporateTaxRate" value="21" min="0" max="50" step="1">
                    </div>
                    <div class="input-group">
                        <label for="postRaisePrice">Post-Raise Token Price ($)</label>
                        <input type="number" id="postRaisePrice" value="0.50" min="0.01" max="10" step="0.01">
                    </div>
                </div>
                
                <button class="calculate-btn" onclick="calculateLoanModel()">Calculate Loan Model</button>
            </div>
            
            <div id="loan-main-results" class="hidden">
                <div class="info-box">
                    <h3>Deal Structure Summary</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Total Loans</div>
                            <div class="info-value" id="totalLoans">$0</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Total to Purchasers</div>
                            <div class="info-value" id="totalToInvestors">$0</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">G2 Success Fees</div>
                            <div class="info-value" id="g2TotalFees">$0</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">G2 Investment in Yafa</div>
                            <div class="info-value" id="g2YafaInvestment">$0</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">G2 Value Post-Raise</div>
                            <div class="info-value" id="g2YafaValuePostRaise">$0</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">File Management Fees</div>
                            <div class="info-value" id="fileFees">$0</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Amount to Yafa Ltd</div>
                            <div class="info-value" id="amountToYafa">$0</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Amount to Yafa (Cash Flow)</div>
                            <div class="info-value" id="amountToYafaCash">$0</div>
                        </div>
                    </div>
                </div>
                
                <div class="info-box">
                    <h3>Purchaser Breakdown</h3>
                    <h4>Individual Purchaser (Per Person)</h4>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Cash Held</div>
                            <div class="info-value" id="individualCashHeld">$0</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Amount Purchased (USD)</div>
                            <div class="info-value" id="individualInvestmentAmount">$0</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Post-Raise Value</div>
                            <div class="info-value" id="individualPostRaiseValue">$0</div>
                        </div>
                    </div>
                    
                    <h4>Group Totals (All Purchasers)</h4>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Total Cash Held</div>
                            <div class="info-value" id="groupCashHeld">$0</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Total Amount Purchased (USD)</div>
                            <div class="info-value" id="groupInvestmentAmount">$0</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Total Post-Raise Value</div>
                            <div class="info-value" id="groupPostRaiseValue">$0</div>
                        </div>
                    </div>
                </div>
                
                <div class="info-box">
                    <h3>Chart Injection (Funding Round)</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">G2 Contribution</div>
                            <div class="info-value" id="g2ChartContribution">$0</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Purchaser Contribution</div>
                            <div class="info-value" id="investorChartContribution">$0</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Yafa Base Contribution</div>
                            <div class="info-value" id="yafaChartContribution">$0</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Net Cash Flow to Yafa</div>
                            <div class="info-value" id="netCashToYafa">$0</div>
                        </div>
                    </div>
                </div>
                
                <div class="info-box">
                    <h3>Token Allocation</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Purchaser Tokens (Total)</div>
                            <div class="info-value" id="investorTokens">0</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Purchaser Cost Basis per Token</div>
                            <div class="info-value" id="investorCostBasis">$0</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">G2 Tokens (Total)</div>
                            <div class="info-value" id="g2Tokens">0</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">G2 Cost Basis per Token</div>
                            <div class="info-value" id="g2CostBasis">$0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Business Returns Tab -->
        <div id="business-returns" class="tab-content">
            <div class="results-card">
                <h3 class="section-title">üíº Individual Business Returns</h3>
                <div class="summary-grid" id="business-summary"></div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Year</th>
                                <th>Tokens Held</th>
                                <th>Tokens Vested</th>
                                <th>Tokens Sold</th>
                                <th>Token Price</th>
                                <th>Gross Sale Amount</th>
                                <th>Capital Gains Tax</th>
                                <th>Net After Tax</th>
                                <th>Loan Payment</th>
                                <th>Cumulative Net Cash</th>
                                <th>Remaining Tokens Value</th>
                            </tr>
                        </thead>
                        <tbody id="business-table"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- G2 Returns Tab -->
        <div id="g2-returns" class="tab-content">
            <div class="results-card">
                <h3 class="section-title">ü§ù G2 Returns</h3>
                <div class="summary-grid" id="g2-summary"></div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Year</th>
                                <th>Tokens Held</th>
                                <th>Tokens Vested</th>
                                <th>Tokens Sold</th>
                                <th>Token Price</th>
                                <th>Gross Sale Amount</th>
                                <th>Capital Gains Tax</th>
                                <th>Net After Tax</th>
                                <th>Cumulative Net Cash</th>
                                <th>Remaining Tokens Value</th>
                            </tr>
                        </thead>
                        <tbody id="g2-table"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Loan Repayment Tab -->
        <div id="loan-repayment" class="tab-content">
            <div class="results-card">
                <h3 class="section-title">üìÖ Loan Repayment Schedule (Annual View)</h3>
                <div class="summary-grid" id="loan-summary"></div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Year</th>
                                <th>Total Annual Payment</th>
                                <th>Per Purchaser Payment</th>
                                <th>Principal</th>
                                <th>Interest</th>
                                <th>Remaining Balance</th>
                            </tr>
                        </thead>
                        <tbody id="loan-table"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Selling Pressure Tab -->
        <div id="selling-pressure" class="tab-content">
            <div class="results-card">
                <h3 class="section-title">üìâ Total Market Selling Pressure (Annual View)</h3>
                <div class="info-box">
                    <p>Note: Shows token sales from Purchasers and G2 for OTC deals and market liquidity</p>
                </div>
                <div class="table-container">
                    <table id="pressure-table">
                        <thead>
                            <tr>
                                <th>Year</th>
                                <th>All Business Token Sales</th>
                                <th>G2 Token Sales</th>
                                <th>Total Token Sales</th>
                                <th>Total Sale Value (Gross)</th>
                                <th>Cumulative Sale Value</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Constants
        const INVESTOR_LOCK_MONTHS = 12;
        const G2_LOCK_MONTHS = 12;
        const G2_VESTING_MONTHS = 72; // 6 years (keeping G2 vesting fixed at 6 years)
        
        // Global data storage
        let loanModelData = {};
        let businessData = [];
        let g2Data = [];
        let loanSchedule = [];
        let sellingPressureData = [];
        let yafaData = [];
        
        function switchTab(tabName, btn) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(tabName);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Highlight active button
            if (btn) {
                btn.classList.add('active');
            }
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }
        
        function formatNumber(amount) {
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }
        
        function formatTokenAmount(amount) {
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }
        
        function formatPercentage(amount) {
            return (amount * 100).toFixed(1) + '%';
        }
        
        // Loan Model Calculation
        function calculateLoanModel() {
            // Get inputs
            const numInvestors = parseInt(document.getElementById('numInvestors').value);
            const loanAmount = parseFloat(document.getElementById('loanAmount').value);
            const amountToInvestor = parseFloat(document.getElementById('amountToInvestor').value);
            const interestRate = parseFloat(document.getElementById('interestRate').value) / 100;
            const amortization = parseInt(document.getElementById('amortization').value);
            const businessVesting = parseInt(document.getElementById('businessVesting').value);
            const g2FeePercent = parseFloat(document.getElementById('g2Fee').value) / 100;
            const costPerFile = parseFloat(document.getElementById('costPerFile').value);
            const investorCashMultiplier = parseFloat(document.getElementById('investorCashMultiplier').value);
            const g2CashMultiplier = parseFloat(document.getElementById('g2CashMultiplier').value);
            const investmentPercent = parseFloat(document.getElementById('investmentPercent').value) / 100;
            const annualGrowth = parseFloat(document.getElementById('annualGrowth').value) / 100;
            const investorWithdrawPercent = parseFloat(document.getElementById('investorWithdrawPercent').value) / 100;
            const g2WithdrawPercent = parseFloat(document.getElementById('g2WithdrawPercent').value) / 100;
            const projectionYears = parseInt(document.getElementById('projectionYears').value);
            const corporateTaxRate = parseFloat(document.getElementById('corporateTaxRate').value) / 100;
            const postRaisePrice = parseFloat(document.getElementById('postRaisePrice').value);
            
            // Calculate deal structure
            const totalLoans = numInvestors * loanAmount;
            const totalToInvestors = numInvestors * amountToInvestor;
            const g2TotalFees = totalLoans * g2FeePercent;
            const totalFileCosts = numInvestors * costPerFile;
            const amountToYafa = totalLoans - totalToInvestors - g2TotalFees - totalFileCosts;
            
            // G2 Investment Calculations
            const g2InvestmentPercent = 0.5; // G2 invests 50% of their success fees
            const g2YafaInvestment = g2TotalFees * g2InvestmentPercent;
            const g2YafaValuePostRaise = g2YafaInvestment * g2CashMultiplier;
            
            // Calculate cash vs investment split for investors
            const investorCashHeld = totalToInvestors * (1 - investmentPercent);
            const investorAmountInvested = totalToInvestors * investmentPercent;
            
            // Individual investor breakdowns
            const individualCashHeld = investorCashHeld / numInvestors;
            const individualInvestmentAmount = investorAmountInvested / numInvestors;
            const individualPostRaiseValue = individualInvestmentAmount * investorCashMultiplier;
            
            // Chart contribution calculations (total funding round breakdown)
            const g2ChartContribution = g2YafaInvestment;
            const investorChartContribution = investorAmountInvested;
            const yafaChartContribution = 2700000; // Base $2.7M as mentioned
            
            // Calculate actual cash flow to Yafa after investments
            const amountToYafaCash = amountToYafa - (yafaChartContribution - g2YafaInvestment - investorAmountInvested);
            
            // Calculate token allocations based on multipliers
            const investorTokenAllocation = (investorAmountInvested * investorCashMultiplier) / postRaisePrice;
            const g2TokenAllocation = (g2YafaInvestment * g2CashMultiplier) / postRaisePrice;
            
            // Calculate cost basis per token
            const investorCostBasis = postRaisePrice / investorCashMultiplier;
            const g2CostBasis = postRaisePrice / g2CashMultiplier;
            
            // Store main model data
            loanModelData = {
                numInvestors,
                loanAmount,
                amountToInvestor,
                interestRate,
                amortization,
                businessVesting,
                g2FeePercent,
                investorCashMultiplier,
                g2CashMultiplier,
                investmentPercent,
                totalLoans,
                totalToInvestors,
                g2TotalFees,
                g2YafaInvestment,
                g2YafaValuePostRaise,
                totalFileCosts,
                amountToYafa,
                investorCashHeld,
                investorAmountInvested,
                individualCashHeld,
                individualInvestmentAmount,
                individualPostRaiseValue,
                g2ChartContribution,
                investorChartContribution,
                yafaChartContribution,
                amountToYafaCash,
                investorTokenAllocation,
                g2TokenAllocation,
                investorCostBasis,
                g2CostBasis,
                annualGrowth,
                investorWithdrawPercent,
                g2WithdrawPercent,
                projectionYears,
                corporateTaxRate,
                postRaisePrice
            };
            
            // Display main results
            displayLoanMainResults();
            
            // Calculate all projections (order matters!)
            calculateLoanRepayment();
            calculateBusinessReturns();
            calculateG2Returns();
            calculateSellingPressure();
            calculateYafaImpact();
        }
        
        function displayLoanMainResults() {
            // Deal Structure Summary
            document.getElementById('totalLoans').textContent = formatCurrency(loanModelData.totalLoans);
            document.getElementById('totalToInvestors').textContent = formatCurrency(loanModelData.totalToInvestors);
            document.getElementById('g2TotalFees').textContent = formatCurrency(loanModelData.g2TotalFees);
            document.getElementById('g2YafaInvestment').textContent = formatCurrency(loanModelData.g2YafaInvestment);
            document.getElementById('g2YafaValuePostRaise').textContent = formatCurrency(loanModelData.g2YafaValuePostRaise);
            document.getElementById('fileFees').textContent = formatCurrency(loanModelData.totalFileCosts);
            document.getElementById('amountToYafa').textContent = formatCurrency(loanModelData.amountToYafa);
            document.getElementById('amountToYafaCash').textContent = formatCurrency(loanModelData.amountToYafaCash);
            
            // Individual investor breakdown (per investor)
            document.getElementById('individualCashHeld').textContent = formatCurrency(loanModelData.individualCashHeld);
            document.getElementById('individualInvestmentAmount').textContent = formatCurrency(loanModelData.individualInvestmentAmount);
            document.getElementById('individualPostRaiseValue').textContent = formatCurrency(loanModelData.individualPostRaiseValue);
            
            // Group totals (same as above but for verification)
            document.getElementById('groupCashHeld').textContent = formatCurrency(loanModelData.investorCashHeld);
            document.getElementById('groupInvestmentAmount').textContent = formatCurrency(loanModelData.investorAmountInvested);
            document.getElementById('groupPostRaiseValue').textContent = formatCurrency(loanModelData.investorAmountInvested * loanModelData.investorCashMultiplier);
            
            // Chart Injection (funding round contributions)
            document.getElementById('g2ChartContribution').textContent = formatCurrency(loanModelData.g2ChartContribution);
            document.getElementById('investorChartContribution').textContent = formatCurrency(loanModelData.investorChartContribution);
            document.getElementById('yafaChartContribution').textContent = formatCurrency(loanModelData.yafaChartContribution);
            document.getElementById('netCashToYafa').textContent = formatCurrency(loanModelData.amountToYafaCash);
            
            // Token Allocation
            document.getElementById('investorTokens').textContent = formatNumber(loanModelData.investorTokenAllocation);
            document.getElementById('investorCostBasis').textContent = '$' + loanModelData.investorCostBasis.toFixed(3);
            document.getElementById('g2Tokens').textContent = formatNumber(loanModelData.g2TokenAllocation);
            document.getElementById('g2CostBasis').textContent = '$' + loanModelData.g2CostBasis.toFixed(3);
            
            document.getElementById('loan-main-results').classList.remove('hidden');
        }
        
        // Business Returns Calculation (Updated with Variable Vesting)
        function calculateBusinessReturns() {
            businessData = [];
            const tokensPerInvestor = loanModelData.investorTokenAllocation / loanModelData.numInvestors;
            const annualVestAmount = tokensPerInvestor / loanModelData.businessVesting; // Variable vesting period
            const cashPerInvestor = loanModelData.investorCashHeld / loanModelData.numInvestors;
            
            let tokensHeld = tokensPerInvestor;
            let remainingCash = cashPerInvestor;
            let totalVested = 0;
            let cumulativeNetCash = remainingCash; // Start with initial cash
            let tokenPrice = loanModelData.postRaisePrice;
            
            for (let year = 1; year <= loanModelData.projectionYears; year++) {
                tokenPrice = loanModelData.postRaisePrice * Math.pow(1 + loanModelData.annualGrowth, year - 1);
                
                let tokensVestedThisYear = 0;
                let tokensSoldThisYear = 0;
                let grossSaleAmount = 0;
                let capitalGainsTax = 0;
                let netAfterTax = 0;
                let loanPayment = 0;
                
                // Calculate loan payment for this year
                if (year <= loanModelData.amortization && year <= loanSchedule.length) {
                    loanPayment = loanSchedule[year - 1].annualPaymentPerInvestor;
                }
                
                // Year 1: Lock period, no vesting, subtract loan payment from cash
                if (year === 1) {
                    tokensVestedThisYear = 0;
                    tokensSoldThisYear = 0;
                    cumulativeNetCash -= loanPayment;
                }
                // Vesting period: Years 2 to (1 + businessVesting)
                else if (year >= 2 && year <= (1 + loanModelData.businessVesting)) {
                    tokensVestedThisYear = annualVestAmount;
                    totalVested += tokensVestedThisYear;
                    tokensSoldThisYear = tokensVestedThisYear * loanModelData.investorWithdrawPercent;
                    tokensHeld -= tokensSoldThisYear;
                    
                    grossSaleAmount = tokensSoldThisYear * tokenPrice;
                    
                    // Calculate capital gains tax
                    const costBasis = tokensSoldThisYear * loanModelData.investorCostBasis;
                    const capitalGains = Math.max(0, grossSaleAmount - costBasis);
                    capitalGainsTax = capitalGains * loanModelData.corporateTaxRate;
                    netAfterTax = grossSaleAmount - capitalGainsTax;
                    
                    // Add token sale proceeds, then subtract loan payment
                    cumulativeNetCash += netAfterTax - loanPayment;
                }
                // Post-vesting: No more vesting, but may still have loan payments
                else {
                    tokensVestedThisYear = 0;
                    tokensSoldThisYear = 0;
                    // Still subtract loan payment if applicable
                    cumulativeNetCash -= loanPayment;
                }
                
                businessData.push({
                    year,
                    tokensHeld,
                    tokensVested: tokensVestedThisYear,
                    tokensSold: tokensSoldThisYear,
                    tokenPrice,
                    grossSaleAmount,
                    capitalGainsTax,
                    netAfterTax,
                    loanPayment,
                    cumulativeNetCash,
                    remainingValue: tokensHeld * tokenPrice
                });
            }
            
            displayBusinessReturns();
        }
        
        function displayBusinessReturns() {
            const finalData = businessData[businessData.length - 1];
            const totalReturn = finalData.cumulativeNetCash + finalData.remainingValue;
            const initialInvestment = loanModelData.amountToInvestor;
            const roi = ((totalReturn - initialInvestment) / initialInvestment * 100).toFixed(0);
            
            document.getElementById('business-summary').innerHTML = `
                <div class="summary-card">
                    <h4>Loan Amount</h4>
                    <div class="value">${formatCurrency(loanModelData.loanAmount)}</div>
                </div>
                <div class="summary-card">
                    <h4>USD Amount for Purchase </h4>
                    <div class="value">${formatCurrency(loanModelData.individualInvestmentAmount)}</div>
                </div>
                <div class="summary-card">
                    <h4>Cash Held</h4>
                    <div class="value">${formatCurrency(loanModelData.individualCashHeld)}</div>
                </div>
                <div class="summary-card">
                    <h4>Tokens Allocated</h4>
                    <div class="value">${formatNumber(loanModelData.investorTokenAllocation / loanModelData.numInvestors)}</div>
                </div>
                <div class="summary-card">
                    <h4>Final Portfolio</h4>
                    <div class="value">${formatCurrency(finalData.remainingValue)}</div>
                </div>
                <div class="summary-card">
                    <h4>Net Cash Generated</h4>
                    <div class="value">${formatCurrency(finalData.cumulativeNetCash)}</div>
                </div>
                <div class="summary-card">
                    <h4>Total Return</h4>
                    <div class="value">${formatCurrency(totalReturn)}</div>
                </div>
                <div class="summary-card">
                    <h4>ROI</h4>
                    <div class="value">${roi}%</div>
                </div>
            `;
            
            document.getElementById('business-table').innerHTML = businessData.map(row => `
                <tr>
                    <td>Year ${row.year}</td>
                    <td>${formatNumber(row.tokensHeld)}</td>
                    <td>${formatNumber(row.tokensVested)}</td>
                    <td>${formatNumber(row.tokensSold)}</td>
                    <td>$${row.tokenPrice.toFixed(3)}</td>
                    <td>${formatCurrency(row.grossSaleAmount)}</td>
                    <td>${formatCurrency(row.capitalGainsTax)}</td>
                    <td>${formatCurrency(row.netAfterTax)}</td>
                    <td>${formatCurrency(row.loanPayment)}</td>
                    <td>${formatCurrency(row.cumulativeNetCash)}</td>
                    <td>${formatCurrency(row.remainingValue)}</td>
                </tr>
            `).join('');
        }
        
        // G2 Returns Calculation (Updated Structure)
        function calculateG2Returns() {
            g2Data = [];
            const g2Tokens = loanModelData.g2TokenAllocation;
            const annualVestAmount = g2Tokens / 6; // G2 still has 6-year vesting
            
            // G2 Fee Components
            const g2FeesCollected = loanModelData.g2TotalFees;
            const g2ServiceFee = loanModelData.totalFileCosts;
            const amountInvestedIntoYafa = loanModelData.g2YafaInvestment;
            const g2FeesCollectedCash = g2FeesCollected / 2;
            
            let tokensHeld = g2Tokens;
            let totalVested = 0;
            let cumulativeNetCash = g2FeesCollectedCash + g2ServiceFee; // Start with initial cash
            let tokenPrice = loanModelData.postRaisePrice;
            
            for (let year = 1; year <= loanModelData.projectionYears; year++) {
                tokenPrice = loanModelData.postRaisePrice * Math.pow(1 + loanModelData.annualGrowth, year - 1);
                
                let tokensVestedThisYear = 0;
                let tokensSoldThisYear = 0;
                let grossSaleAmount = 0;
                let capitalGainsTax = 0;
                let netAfterTax = 0;
                
                // Year 1: Lock period, no vesting
                if (year === 1) {
                    tokensVestedThisYear = 0;
                    tokensSoldThisYear = 0;
                }
                // Years 2-7: Vesting period (G2 keeps 6-year vesting)
                else if (year >= 2 && year <= 7) {
                    tokensVestedThisYear = annualVestAmount;
                    totalVested += tokensVestedThisYear;
                    tokensSoldThisYear = tokensVestedThisYear * loanModelData.g2WithdrawPercent;
                    tokensHeld -= tokensSoldThisYear;
                    
                    grossSaleAmount = tokensSoldThisYear * tokenPrice;
                    
                    // Calculate capital gains tax
                    const costBasis = tokensSoldThisYear * loanModelData.g2CostBasis;
                    const capitalGains = Math.max(0, grossSaleAmount - costBasis);
                    capitalGainsTax = capitalGains * loanModelData.corporateTaxRate;
                    netAfterTax = grossSaleAmount - capitalGainsTax;
                    cumulativeNetCash += netAfterTax;
                }
                // Years 8+: No more vesting
                else {
                    tokensVestedThisYear = 0;
                    tokensSoldThisYear = 0;
                }
                
                g2Data.push({
                    year,
                    tokensHeld,
                    tokensVested: tokensVestedThisYear,
                    tokensSold: tokensSoldThisYear,
                    tokenPrice,
                    grossSaleAmount,
                    capitalGainsTax,
                    netAfterTax,
                    cumulativeNetCash,
                    remainingValue: tokensHeld * tokenPrice,
                    // Store G2 specific values for summary
                    g2FeesCollected,
                    g2ServiceFee,
                    amountInvestedIntoYafa,
                    g2FeesCollectedCash
                });
            }
            
            displayG2Returns();
        }
        
        function displayG2Returns() {
            const finalData = g2Data[g2Data.length - 1];
            const totalCashGenerated = finalData.cumulativeNetCash;
            const totalReturn = finalData.cumulativeNetCash + finalData.remainingValue;
            const initialInvestment = finalData.amountInvestedIntoYafa;
            const roi = ((totalReturn - initialInvestment) / initialInvestment * 100).toFixed(0);
            
            // Calculate cash generated from token sales only
            const cashFromTokenSales = totalCashGenerated - finalData.g2ServiceFee - finalData.g2FeesCollectedCash;
            
            // Calculate ROI on Yafa Investment (token-related returns only)
            const yafaInvestmentReturn = cashFromTokenSales + finalData.remainingValue;
            const roiOnYafaInvestment = ((yafaInvestmentReturn) / initialInvestment * 100).toFixed(0);
            
            document.getElementById('g2-summary').innerHTML = `
                <div class="summary-card">
                    <h4>G2 Fees Collected</h4>
                    <div class="value">${formatCurrency(finalData.g2FeesCollected)}</div>
                </div>
                <div class="summary-card">
                    <h4>G2 Service Fee</h4>
                    <div class="value">${formatCurrency(finalData.g2ServiceFee)}</div>
                </div>
                <div class="summary-card">
                    <h4>USD for YAFA Purchase</h4>
                    <div class="value">${formatCurrency(finalData.amountInvestedIntoYafa)}</div>
                </div>
                <div class="summary-card">
                    <h4>G2 Fees Collected Cash</h4>
                    <div class="value">${formatCurrency(finalData.g2FeesCollectedCash)}</div>
                </div>
                <div class="summary-card">
                    <h4>Cash Generated from Token Sales</h4>
                    <div class="value">${formatCurrency(cashFromTokenSales)}</div>
                </div>
                <div class="summary-card">
                    <h4>Tokens Allocated</h4>
                    <div class="value">${formatNumber(loanModelData.g2TokenAllocation)}</div>
                </div>
                <div class="summary-card">
                    <h4>Final Portfolio</h4>
                    <div class="value">${formatCurrency(finalData.remainingValue)}</div>
                </div>
                <div class="summary-card">
                    <h4>Total Cash Generated</h4>
                    <div class="value">${formatCurrency(totalCashGenerated)}</div>
                </div>
                <div class="summary-card">
                    <h4>ROI on Yafa Purchase</h4>
                    <div class="value">${roiOnYafaInvestment}%</div>
                </div>
            `;
            
            document.getElementById('g2-table').innerHTML = g2Data.map(row => `
                <tr>
                    <td>Year ${row.year}</td>
                    <td>${formatNumber(row.tokensHeld)}</td>
                    <td>${formatNumber(row.tokensVested)}</td>
                    <td>${formatNumber(row.tokensSold)}</td>
                    <td>$${row.tokenPrice.toFixed(3)}</td>
                    <td>${formatCurrency(row.grossSaleAmount)}</td>
                    <td>${formatCurrency(row.capitalGainsTax)}</td>
                    <td>${formatCurrency(row.netAfterTax)}</td>
                    <td>${formatCurrency(row.cumulativeNetCash)}</td>
                    <td>${formatCurrency(row.remainingValue)}</td>
                </tr>
            `).join('');
        }
        
        // Loan Repayment Calculation
        function calculateLoanRepayment() {
            loanSchedule = [];
            const monthlyRate = loanModelData.interestRate / 12;
            const totalMonths = loanModelData.amortization * 12;
            const loanPerInvestor = loanModelData.loanAmount;
            
            // Calculate monthly payment using amortization formula
            const monthlyPayment = loanPerInvestor * (monthlyRate * Math.pow(1 + monthlyRate, totalMonths)) / 
                                   (Math.pow(1 + monthlyRate, totalMonths) - 1);
            
            let remainingBalance = loanPerInvestor * loanModelData.numInvestors;
            
            // Calculate annual summaries
            for (let year = 1; year <= loanModelData.amortization; year++) {
                let annualPayment = 0;
                let annualPrincipal = 0;
                let annualInterest = 0;
                
                for (let month = 1; month <= 12; month++) {
                    if ((year - 1) * 12 + month <= totalMonths) {
                        const interest = remainingBalance * monthlyRate;
                        const principal = (monthlyPayment * loanModelData.numInvestors) - interest;
                        
                        annualPayment += monthlyPayment * loanModelData.numInvestors;
                        annualPrincipal += principal;
                        annualInterest += interest;
                        remainingBalance -= principal;
                    }
                }
                
                loanSchedule.push({
                    year,
                    annualPayment,
                    annualPaymentPerInvestor: annualPayment / loanModelData.numInvestors,
                    annualPrincipal,
                    annualInterest,
                    remainingBalance: Math.max(0, remainingBalance)
                });
            }
            
            displayLoanRepayment();
        }
        
        function displayLoanRepayment() {
            const totalPayments = loanSchedule.reduce((sum, row) => sum + row.annualPayment, 0);
            const totalInterest = totalPayments - loanModelData.totalLoans;
            
            document.getElementById('loan-summary').innerHTML = `
                <div class="summary-card">
                    <h4>Total Loan Amount</h4>
                    <div class="value">${formatCurrency(loanModelData.totalLoans)}</div>
                </div>
                <div class="summary-card">
                    <h4>Annual Payment (Avg)</h4>
                    <div class="value">${formatCurrency(totalPayments / loanModelData.amortization)}</div>
                </div>
                <div class="summary-card">
                    <h4>Total Interest</h4>
                    <div class="value">${formatCurrency(totalInterest)}</div>
                </div>
                <div class="summary-card">
                    <h4>Total Payments</h4>
                    <div class="value">${formatCurrency(totalPayments)}</div>
                </div>
            `;
            
            document.getElementById('loan-table').innerHTML = loanSchedule.map(row => `
                <tr>
                    <td>Year ${row.year}</td>
                    <td>${formatCurrency(row.annualPayment)}</td>
                    <td>${formatCurrency(row.annualPaymentPerInvestor)}</td>
                    <td>${formatCurrency(row.annualPrincipal)}</td>
                    <td>${formatCurrency(row.annualInterest)}</td>
                    <td>${formatCurrency(row.remainingBalance)}</td>
                </tr>
            `).join('');
        }
        
        // Selling Pressure Calculation
        function calculateSellingPressure() {
            sellingPressureData = [];
            let cumulativeSaleValue = 0;
            
            for (let year = 1; year <= loanModelData.projectionYears; year++) {
                // Get business token sales for this year (all investors combined)
                let businessTokenSales = 0;
                let businessSaleValue = 0;
                if (year <= businessData.length) {
                    businessTokenSales = businessData[year - 1].tokensSold * loanModelData.numInvestors;
                    businessSaleValue = businessData[year - 1].grossSaleAmount * loanModelData.numInvestors;
                }
                
                // Get G2 token sales for this year
                let g2TokenSales = 0;
                let g2SaleValue = 0;
                if (year <= g2Data.length) {
                    g2TokenSales = g2Data[year - 1].tokensSold;
                    g2SaleValue = g2Data[year - 1].grossSaleAmount;
                }
                
                const totalTokenSales = businessTokenSales + g2TokenSales;
                const totalSaleValue = businessSaleValue + g2SaleValue;
                cumulativeSaleValue += totalSaleValue;
                
                sellingPressureData.push({
                    year,
                    businessTokenSales,
                    g2TokenSales,
                    totalTokenSales,
                    totalSaleValue,
                    cumulativeSaleValue
                });
            }
            
            displaySellingPressure();
        }
        
        function displaySellingPressure() {
            const tableBody = document.querySelector('#pressure-table tbody');
            tableBody.innerHTML = sellingPressureData.map(row => `
                <tr>
                    <td>Year ${row.year}</td>
                    <td>${formatTokenAmount(row.businessTokenSales)}</td>
                    <td>${formatTokenAmount(row.g2TokenSales)}</td>
                    <td>${formatTokenAmount(row.totalTokenSales)}</td>
                    <td>${formatCurrency(row.totalSaleValue)}</td>
                    <td>${formatCurrency(row.cumulativeSaleValue)}</td>
                </tr>
            `).join('');
        }
        
        // Placeholder for Yafa Impact calculation
        function calculateYafaImpact() {
            // This function can be expanded if needed for additional analysis
            yafaData = [];
        }
    </script>
</body>
</html>